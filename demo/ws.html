<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
    </head>
    <body>
        <div id="time"></div>
        <div id="current"></div>
        <div id="buffered"></div>
        <video controls></video>
    <script>

    var video = document.querySelector('video');

    var firstData = true;
    var queue = [];
    var sourceBuffer = null;
    var mimeCodec = 'video/mp4; codecs="avc1.42e028"';
    var mediaSource = null;
    var startTime = (new Date()).getTime();
    var stopTimer = function () {
        console.log('Got playing event');
        document.getElementById('time').innerHTML = '' + ((new Date()).getTime() - startTime) + ' ms';
        video.removeEventListener('playing', stopTimer);
    };

    var wsURL = 'ws://rocket.umbocv.com:8080/client';

    createMediaSource();

    function createMediaSource() {
        if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {
            mediaSource = new MediaSource;
            video.src = URL.createObjectURL(mediaSource);
            video.addEventListener('playing', stopTimer);
            mediaSource.addEventListener('sourceopen', addSourceBuffer);
        } else {
            console.error('Unsupported MIME type or codec: ', mimeCodec);
        }

        console.log("Done with createMediaSource");
    }

    function addSourceBuffer (_) {

        sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        sourceBuffer.mode = 'sequence';
        sourceBuffer.addEventListener('update', function() {
            if (queue.length > 0) {
                console.log("update");
                sourceBuffer.appendBuffer(queue.shift());
            } else {
                firstData = true;
            }
        });

        video.addEventListener('timeupdate', function () {
            document.getElementById('current').innerHTML = '' + 'Current time: ' + video.currentTime;

            var bufferedRange = sourceBuffer.buffered;
            document.getElementById('buffered').innerHTML = '';
            for (var i = 0; i < bufferedRange.length; i++) {
                document.getElementById('buffered').innerHTML += '' + 'Buffer(' + i +'): ' + bufferedRange.start(i) + ' - ' + bufferedRange.end(i) + '\n';
            }
        });
        video.addEventListener('canplay', function () {
            console.log('Got can play event');
            video.play();
        });

        console.log("Done with addSourceBuffer");

        var ws = new WebSocket(wsURL);
        ws.binaryType = "arraybuffer";

        ws.onopen = function() {
            console.log("WebSocket is connected.");
        };

        ws.onmessage = function (evt) {
            if (evt.data instanceof ArrayBuffer) {
                console.log("evt: ", evt.data.byteLength);
                if (firstData) {
                    sourceBuffer.appendBuffer(new Uint8Array(evt.data));
                    firstData = false;
                } else {
                    if (queue.length > 0) {
                        console.log("Got other chunks in queue");
                    }
                    queue.push(new Uint8Array(evt.data));
                }
            }
        };

        ws.onclose = function(evt) {
            console.log("WebSocket is closed: ", evt.reason, evt.code);
        };

        ws.onerror = function (evt) {
            console.log("WebSocket error: ", evt.data);
        }
    }

</script>
</body>
</html>

